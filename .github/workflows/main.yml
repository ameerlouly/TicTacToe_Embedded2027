name: Build Packet_Versions/Packet1/test_0.pro

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Debug workspace
      run: |
        pwd
        ls -R

    - name: Install Qt (MinGW)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.8.3'
        arch: 'win64_mingw'

    - name: Add Qt bin directory to PATH
      run: echo "C:\Qt\6.8.3\mingw_64\bin" >> $env:GITHUB_PATH

    - name: Build test_0.pro inside Packets_Versions
      run: |
        cd Packet_Versions/Packet1
        qmake test_0.pro CONFIG-=no_main CONFIG+=console
        mingw32-make

    - name: Find and run test executable
      shell: pwsh
      run: |
        # Search for the test_0.exe file
        $exe = Get-ChildItem -Path . -Filter test_0.exe -Recurse -File | Select-Object -First 1
    
        if (-not $exe) {
          Write-Error "Executable test_0.exe not found."
          exit 1
        }
    
        Write-Host "Found test executable at: $($exe.FullName)"
    
        # Run the executable and capture output
        & $exe.FullName | Tee-Object -FilePath test_output.txt
    
        # Check the exit code to fail the pipeline on test failure
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Tests failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
    
    
