name: Build Packet_Versions/Packet1/test_0.pro

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Debug workspace
      run: |
        pwd
        ls -R

    - name: Install Qt (MinGW)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.8.3'
        arch: 'win64_mingw'

    - name: Add Qt bin directory to PATH
      run: echo "C:\Qt\6.8.3\mingw_64\bin" >> $env:GITHUB_PATH

    - name: Build test_0.pro inside Packets_Versions
      run: |
        cd Packet_Versions/Packet1
        qmake test_0.pro CONFIG-=no_main CONFIG+=console
        mingw32-make

    - name: Find and run test executable
      shell: pwsh
      run: |
        $exeDir = "C:\a\TicTacToe_Embedded2027\TicTacToe_Embedded2027\Packet_Versions\Packet1\build\Desktop_Qt_6_9_0_MinGW_64_bit-Debug\debug"
        $exePath = Join-Path $exeDir "test_0.exe"
        $logPath = Join-Path $exeDir "test_output.txt"
    
        $qtBin = "C:\a\TicTacToe_Embedded2027\Qt\6.8.3\mingw_64\bin"
        $qtPlugins = "C:\a\TicTacToe_Embedded2027\Qt\6.8.3\mingw_64\plugins"
    
        if (-not (Test-Path $exePath)) {
          Write-Error "Executable test_0.exe not found at $exePath"
          exit 1
        }
    
        Write-Host "Found test executable at: $exePath"
    
        # List of required DLLs (optional)
        $qtDlls = @()
    
        foreach ($dll in $qtDlls) {
          $source = Join-Path $qtBin $dll
          $destination = Join-Path $exeDir $dll
          if (Test-Path $source) {
            Copy-Item $source $destination -Force
            Write-Host "Copied $dll to test folder."
          } else {
            Write-Warning "$dll not found in $qtBin"
          }
        }
    
        # Copy platform plugins
        $platformsSource = Join-Path $qtPlugins "platforms"
        $platformsTarget = Join-Path $exeDir "platforms"
        if (Test-Path $platformsSource) {
          New-Item -Path $platformsTarget -ItemType Directory -Force | Out-Null
          Copy-Item -Path (Join-Path $platformsSource "qwindows.dll") -Destination $platformsTarget -Force
          Write-Host "Copied qwindows.dll to platforms folder."
        } else {
          Write-Warning "Qt platforms plugin folder not found at $platformsSource"
        }
    
        # Enable Qt debug info
        $env:QT_DEBUG_PLUGINS = "1"
    
        # Make sure the output file exists
        if (-not (Test-Path $logPath)) {
          New-Item -Path $logPath -ItemType File -Force | Out-Null
        }
    
        # Run the test and capture output
        & $exePath | Tee-Object -FilePath $logPath
    
        # Check for test failure
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Tests failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
    
    - name: Upload test output log
      uses: actions/upload-artifact@v4
      with:
        name: test_output
        path: C:\a\TicTacToe_Embedded2027\TicTacToe_Embedded2027\Packet_Versions\Packet1\build\Desktop_Qt_6_9_0_MinGW_64_bit-Debug\debug\test_output.txt
